rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }

    // Users
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
    }

    // Paycheck Estimates
    match /paycheck_estimates/{estimateId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId)
        && request.resource.data.schemaVersion == 2
        && request.resource.data.result.netCents is number;
    }

    // Transactions
    match /transactions/{transactionId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
    
    // Shifts
    match /shifts/{shiftId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
    
    // Tax Profiles
     match /tax_profiles/{userId} {
        allow read, write: if isOwner(userId);
    }
    
    // Obligations
     match /obligations/{obligationId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
    
    // Debt Accounts
     match /debts_accounts/{accountId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }

    // Payoff Plans
    match /payoff_plans/{planId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
    match /payoff_plans_runs/{runId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
    match /payoff_plans_runs/{runId}/schedule/{ym} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
     match /payoff_overrides/{overrideId} {
        allow read, write: if isOwner(request.resource.data.userId);
    }
    
    // BNPL Data
    match /users/{uid}/bnpl/contracts/{contractId} {
      allow read: if isOwner(uid);
      allow write: if false; // writes via Admin SDK only
    }
    match /users/{uid}/bnpl/contracts/{contractId}/installments/{instId} {
      allow read: if isOwner(uid);
      allow write: if false;
    }
    match /users/{uid}/bnpl/contracts/{contractId}/links/{linkId} {
      allow read: if isOwner(uid);
      allow write: if false;
    }
  }
}
