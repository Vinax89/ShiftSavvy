import type { NextConfig } from 'next';
import bundleAnalyzer from '@next/bundle-analyzer';
import path from 'path';

const withBundleAnalyzer = bundleAnalyzer({ enabled: process.env.ANALYZE === 'true' });

// Strings, not regex:
const allowedFromEnv = (process.env.NEXT_ALLOWED_DEV_ORIGINS || '')
  .split(',').map(s => s.trim()).filter(Boolean);

const nextConfig: NextConfig = {
  ...(allowedFromEnv.length ? { allowedDevOrigins: allowedFromEnv } : {}),
  webpack: (config, { dev }) => {
    if (dev) {
      // @ts-ignore
      config.cache = { type: 'memory' };
    }
    // Ensure @ alias always works at runtime
    config.resolve = config.resolve || {};
    config.resolve.alias = { ...(config.resolve.alias || {}), '@': path.resolve(__dirname, 'src') };

    config.ignoreWarnings ||= [];
    config.ignoreWarnings.push(/Critical dependency: the request of a dependency is an expression/);
    return config;
  },
};

export default withBundleAnalyzer(nextConfig);
